// äº¤ä¸ªç¥ä»™æœ‹å‹ PWA Service Worker
const CACHE_NAME = 'divine-friend-pwa-v1.0.0'
const STATIC_CACHE_URLS = [
  '/',
  '/manifest.json',
  '/static/css/main.css',
  '/static/js/main.js',
  'https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;600;700&display=swap'
]

// å®‰è£…äº‹ä»¶ - ç¼“å­˜é™æ€èµ„æº
self.addEventListener('install', (event) => {
  console.log('ğŸš€ Service Worker æ­£åœ¨å®‰è£…...')
  
  event.waitUntil(
    caches.open(CACHE_NAME)
      .then((cache) => {
        console.log('ğŸ“¦ æ­£åœ¨ç¼“å­˜é™æ€èµ„æº...')
        return cache.addAll(STATIC_CACHE_URLS)
      })
      .then(() => {
        console.log('âœ… é™æ€èµ„æºç¼“å­˜å®Œæˆ')
        // å¼ºåˆ¶æ¿€æ´»æ–°çš„ Service Worker
        return self.skipWaiting()
      })
      .catch((error) => {
        console.error('âŒ ç¼“å­˜å¤±è´¥:', error)
      })
  )
})

// æ¿€æ´»äº‹ä»¶ - æ¸…ç†æ—§ç¼“å­˜
self.addEventListener('activate', (event) => {
  console.log('ğŸ”„ Service Worker æ­£åœ¨æ¿€æ´»...')
  
  event.waitUntil(
    caches.keys()
      .then((cacheNames) => {
        return Promise.all(
          cacheNames.map((cacheName) => {
            if (cacheName !== CACHE_NAME) {
              console.log('ğŸ—‘ï¸ åˆ é™¤æ—§ç¼“å­˜:', cacheName)
              return caches.delete(cacheName)
            }
          })
        )
      })
      .then(() => {
        console.log('âœ… Service Worker æ¿€æ´»å®Œæˆ')
        // ç«‹å³æ§åˆ¶æ‰€æœ‰é¡µé¢
        return self.clients.claim()
      })
  )
})

// æ‹¦æˆªç½‘ç»œè¯·æ±‚
self.addEventListener('fetch', (event) => {
  // åªå¤„ç† GET è¯·æ±‚
  if (event.request.method !== 'GET') {
    return
  }

  // è·³è¿‡é HTTP(S) è¯·æ±‚
  if (!event.request.url.startsWith('http')) {
    return
  }

  event.respondWith(
    caches.match(event.request)
      .then((cachedResponse) => {
        // å¦‚æœç¼“å­˜ä¸­æœ‰å“åº”ï¼Œç›´æ¥è¿”å›
        if (cachedResponse) {
          console.log('ğŸ“¦ ä»ç¼“å­˜è¿”å›:', event.request.url)
          return cachedResponse
        }

        // ç½‘ç»œè¯·æ±‚
        return fetch(event.request)
          .then((response) => {
            // æ£€æŸ¥å“åº”æ˜¯å¦æœ‰æ•ˆ
            if (!response || response.status !== 200 || response.type !== 'basic') {
              return response
            }

            // å…‹éš†å“åº”ç”¨äºç¼“å­˜
            const responseToCache = response.clone()

            // ç¼“å­˜æ–°çš„å“åº”
            caches.open(CACHE_NAME)
              .then((cache) => {
                // åªç¼“å­˜ç‰¹å®šç±»å‹çš„èµ„æº
                if (shouldCache(event.request.url)) {
                  console.log('ğŸ’¾ ç¼“å­˜æ–°èµ„æº:', event.request.url)
                  cache.put(event.request, responseToCache)
                }
              })

            return response
          })
          .catch((error) => {
            console.log('ğŸŒ ç½‘ç»œè¯·æ±‚å¤±è´¥:', event.request.url, error)
            
            // å¦‚æœæ˜¯å¯¼èˆªè¯·æ±‚ä¸”å¤±è´¥ï¼Œè¿”å›ç¦»çº¿é¡µé¢
            if (event.request.mode === 'navigate') {
              return caches.match('/')
            }
            
            throw error
          })
      })
  )
})

// åˆ¤æ–­æ˜¯å¦åº”è¯¥ç¼“å­˜è¯¥èµ„æº
function shouldCache(url) {
  // ç¼“å­˜ç­–ç•¥ï¼šç¼“å­˜é™æ€èµ„æºå’ŒAPIå“åº”
  const cachePatterns = [
    /\.(js|css|png|jpg|jpeg|gif|svg|woff|woff2|ttf|eot)$/,
    /\/api\//,
    /fonts\.googleapis\.com/
  ]
  
  return cachePatterns.some(pattern => pattern.test(url))
}

// åå°åŒæ­¥äº‹ä»¶ï¼ˆå¦‚æœæ”¯æŒï¼‰
if ('sync' in self.registration) {
  self.addEventListener('sync', (event) => {
    console.log('ğŸ”„ åå°åŒæ­¥äº‹ä»¶:', event.tag)
    
    if (event.tag === 'blessing-sync') {
      event.waitUntil(syncBlessings())
    }
  })
}

// æ¨é€é€šçŸ¥äº‹ä»¶
self.addEventListener('push', (event) => {
  console.log('ğŸ“± æ”¶åˆ°æ¨é€é€šçŸ¥:', event)
  
  if (event.data) {
    const data = event.data.json()
    const options = {
      body: data.body || 'æ‚¨æœ‰æ–°çš„ç¥ä»™æœ‹å‹æ¶ˆæ¯',
      icon: '/icon-192x192.png',
      badge: '/icon-72x72.png',
      tag: data.tag || 'divine-friend-notification',
      data: data,
      actions: [
        {
          action: 'open',
          title: 'æŸ¥çœ‹',
          icon: '/icon-72x72.png'
        },
        {
          action: 'close',
          title: 'å…³é—­'
        }
      ],
      requireInteraction: true,
      silent: false
    }

    event.waitUntil(
      self.registration.showNotification(data.title || 'ç¥ä»™æœ‹å‹', options)
    )
  }
})

// é€šçŸ¥ç‚¹å‡»äº‹ä»¶
self.addEventListener('notificationclick', (event) => {
  console.log('ğŸ”” é€šçŸ¥è¢«ç‚¹å‡»:', event)
  
  event.notification.close()
  
  if (event.action === 'open' || !event.action) {
    event.waitUntil(
      clients.matchAll({ type: 'window' })
        .then((clientList) => {
          // å¦‚æœå·²æœ‰çª—å£æ‰“å¼€ï¼Œèšç„¦åˆ°è¯¥çª—å£
          for (const client of clientList) {
            if (client.url === self.location.origin && 'focus' in client) {
              return client.focus()
            }
          }
          
          // å¦åˆ™æ‰“å¼€æ–°çª—å£
          if (clients.openWindow) {
            return clients.openWindow('/')
          }
        })
    )
  }
})

// åŒæ­¥ç¥ç¦æ•°æ®ï¼ˆç¤ºä¾‹å‡½æ•°ï¼‰
async function syncBlessings() {
  try {
    console.log('ğŸ™ æ­£åœ¨åŒæ­¥ç¥ç¦æ•°æ®...')
    
    // è¿™é‡Œå¯ä»¥å®ç°å®é™…çš„æ•°æ®åŒæ­¥é€»è¾‘
    // ä¾‹å¦‚ï¼šä» IndexedDB è·å–ç¦»çº¿æ•°æ®å¹¶ä¸Šä¼ åˆ°æœåŠ¡å™¨
    
    console.log('âœ… ç¥ç¦æ•°æ®åŒæ­¥å®Œæˆ')
  } catch (error) {
    console.error('âŒ ç¥ç¦æ•°æ®åŒæ­¥å¤±è´¥:', error)
    throw error
  }
}

// æ¶ˆæ¯å¤„ç†ï¼ˆä¸ä¸»çº¿ç¨‹é€šä¿¡ï¼‰
self.addEventListener('message', (event) => {
  console.log('ğŸ“¨ æ”¶åˆ°æ¶ˆæ¯:', event.data)
  
  if (event.data && event.data.type === 'SKIP_WAITING') {
    self.skipWaiting()
  }
  
  if (event.data && event.data.type === 'GET_VERSION') {
    event.ports[0].postMessage({ version: CACHE_NAME })
  }
})

console.log('ğŸ§˜â€â™‚ï¸ ç¥ä»™æœ‹å‹ Service Worker å·²åŠ è½½') 